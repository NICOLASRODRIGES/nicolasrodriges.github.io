<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Авторизация</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // Check authentication
        if (localStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
</head>
<body>
    <div class="header">
        <h1>Авторизация пользователя</h1>
        <button onclick="logout()" style="float: right; margin-top: -40px;">Выйти</button>
    </div>
    
    <div class="nav">
        <a href="index.html">Главная</a>
        <a href="users.html">Пользователи</a>
        <a href="authorized.html">Авторизация</a>
        <a href="zips.html">Архивы</a>
    </div>
    
    <div class="auth-form">
        <input type="text" id="username" placeholder="Введите имя пользователя">
        <button onclick="authorizeUser()">Авторизовать</button>
        <div id="error" class="error"></div>
        <div id="success" class="success"></div>
    </div>

    <div class="users-list">
        <h2>Все пользователи</h2>
        <div id="users"></div>
    </div>
    <div class="auth-users">
        <h3>Авторизованные пользователи</h3>
        <ul id="authUsers"></ul>
    </div>

    <script>
        const API_URL = 'https://api.jsonbin.io/v3/b/6816ae838a456b7966972667';
        const API_KEY = '$2a10$30DUmftOdCIJqvLSFHqLwePQV9ERhhvW1NFWDEEPor5.F2RoT4vfC';

        // Cache for user data
        let userCache = null;
        let lastFetchTime = 0;
        const CACHE_DURATION = 30000; // 30 seconds

        async function fetchUsers() {
            const now = Date.now();
            if (userCache && (now - lastFetchTime) < CACHE_DURATION) {
                return userCache;
            }

            try {
                const response = await fetch(API_URL, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                const data = await response.json();
                userCache = data.record.users || {};
                lastFetchTime = now;
                return userCache;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        async function authorizeUser() {
            const username = document.getElementById('username').value.trim();
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (!username) {
                errorDiv.textContent = 'Пожалуйста, введите имя пользователя';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const data = await fetchUsers();
                if (!data[username]) {
                    data[username] = {};
                }
                data[username].authorized = true;

                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify({ users: data })
                });

                if (response.ok) {
                    successDiv.textContent = 'Пользователь успешно авторизован!';
                    successDiv.style.display = 'block';
                    userCache = null; // Invalidate cache
                    loadUsers();
                    loadAuthUsers();
                } else {
                    throw new Error('Ошибка при обновлении данных');
                }
            } catch (error) {
                errorDiv.textContent = 'Произошла ошибка: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        async function removeAuthorization(username) {
            if (!confirm(`Снять авторизацию с пользователя ${username}?`)) return;
            
            try {
                const data = await fetchUsers();
                if (data[username]) {
                    data[username].authorized = false;
                    const response = await fetch(API_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY
                        },
                        body: JSON.stringify({ users: data })
                    });

                    if (response.ok) {
                        userCache = null; // Invalidate cache
                        loadAuthUsers();
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadUsers() {
            try {
                const users = await fetchUsers();
                const usersDiv = document.getElementById('users');
                usersDiv.innerHTML = '';
                
                Object.keys(users).forEach(username => {
                    const user = users[username];
                    const row = document.createElement('div');
                    row.className = 'user-row';
                    const status = document.createElement('span');
                    status.className = 'user-status ' + (user.authorized ? 'authorized' : 'unauthorized');
                    status.textContent = user.authorized ? 'Авторизован' : 'Не авторизован';
                    row.appendChild(document.createTextNode(username));
                    row.appendChild(status);
                    if (user.authorized) {
                        const btn = document.createElement('button');
                        btn.className = 'remove-btn';
                        btn.textContent = 'Снять авторизацию';
                        btn.onclick = () => removeAuthorization(username);
                        row.appendChild(btn);
                    }
                    usersDiv.appendChild(row);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadAuthUsers() {
            try {
                const users = await fetchUsers();
                const list = document.getElementById('authUsers');
                list.innerHTML = '';
                
                Object.keys(users).forEach(username => {
                    if (users[username].authorized) {
                        const li = document.createElement('li');
                        li.textContent = username;
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-auth-btn';
                        removeBtn.textContent = 'Снять авторизацию';
                        removeBtn.onclick = () => removeAuthorization(username);
                        li.appendChild(removeBtn);
                        list.appendChild(li);
                    }
                });
                
                if (!list.hasChildNodes()) {
                    list.innerHTML = '<li style="color:#dc3545">Нет авторизованных пользователей</li>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function logout() {
            localStorage.removeItem('isAdmin');
            window.location.href = 'login.html';
        }

        // Initial load
        loadUsers();
        loadAuthUsers();

        // Refresh data every 30 seconds
        setInterval(() => {
            loadUsers();
            loadAuthUsers();
        }, CACHE_DURATION);
    </script>
</body>
</html> 