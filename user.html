<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Данные пользователя</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // Check authentication
        if (localStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
</head>
<body>
    <div class="header">
        <h1>Данные пользователя</h1>
        <button onclick="logout()" style="float: right; margin-top: -40px;">Выйти</button>
    </div>
    
    <div class="nav">
        <a href="index.html">Главная</a>
        <a href="users.html">Пользователи</a>
        <a href="authorized.html">Авторизация</a>
        <a href="zips.html">Архивы</a>
    </div>
    
    <div class="content">
        <div id="status" class="status"></div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Параметр</th>
                    <th>Значение</th>
                </tr>
            </thead>
            <tbody id="userData">
            </tbody>
        </table>
        <div id="downloadBlock" style="margin-top: 20px; display: flex; gap: 10px;"></div>
    </div>

    <script>
        const API_URL = 'https://api.jsonbin.io/v3/b/6816ae838a456b7966972667';
        const API_KEY = '$2a10$30DUmftOdCIJqvLSFHqLwePQV9ERhhvW1NFWDEEPor5.F2RoT4vfC';

        // Cache for user data
        let userCache = null;
        let lastFetchTime = 0;
        const CACHE_DURATION = 30000; // 30 seconds

        function getUrlParameter(name) {
            name = name.replace(/[[\]]/g, '\\$&');
            const regex = new RegExp('[\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        async function fetchUsers() {
            const now = Date.now();
            if (userCache && (now - lastFetchTime) < CACHE_DURATION) {
                return userCache;
            }

            try {
                const response = await fetch(API_URL, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                const data = await response.json();
                userCache = data.record.users || {};
                lastFetchTime = now;
                return userCache;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        async function removeAuthorization(username) {
            if (!confirm(`Снять авторизацию с пользователя ${username}?`)) return;
            
            try {
                const data = await fetchUsers();
                if (data[username]) {
                    data[username].authorized = false;
                    const response = await fetch(API_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY
                        },
                        body: JSON.stringify({ users: data })
                    });

                    if (response.ok) {
                        userCache = null; // Invalidate cache
                        location.reload();
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function displayUserData() {
            const username = getUrlParameter('username');
            if (!username) return;

            document.title = `Данные пользователя ${username}`;
            
            try {
                const users = await fetchUsers();
                const user = users[username];
                
                if (user) {
                    const statusDiv = document.getElementById('status');
                    statusDiv.textContent = user.authorized ? 'Авторизован' : 'Не авторизован';
                    statusDiv.className = `status ${user.authorized ? 'authorized' : 'unauthorized'}`;

                    const tbody = document.getElementById('userData');
                    tbody.innerHTML = '';
                    for (const [key, value] of Object.entries(user)) {
                        if (key !== 'authorized') {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = key;
                            row.insertCell(1).textContent = value;
                        }
                    }

                    const downloadBlock = document.getElementById('downloadBlock');
                    downloadBlock.innerHTML = '';
                    if (user.zip_url) {
                        const downloadBtn = document.createElement('a');
                        downloadBtn.href = user.zip_url;
                        downloadBtn.className = 'download-btn';
                        downloadBtn.textContent = 'Скачать архив';
                        downloadBlock.appendChild(downloadBtn);
                    }
                    if (user.authorized) {
                        const removeBtn = document.createElement('a');
                        removeBtn.href = '#';
                        removeBtn.className = 'remove-auth-btn';
                        removeBtn.textContent = 'Снять авторизацию';
                        removeBtn.onclick = (e) => {
                            e.preventDefault();
                            removeAuthorization(username);
                        };
                        downloadBlock.appendChild(removeBtn);
                    }
                } else {
                    document.getElementById('status').textContent = 'Пользователь не найден';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('status').textContent = 'Ошибка при загрузке данных';
            }
        }

        function logout() {
            localStorage.removeItem('isAdmin');
            window.location.href = 'login.html';
        }

        // Initial load
        displayUserData();

        // Refresh data every 30 seconds
        setInterval(displayUserData, CACHE_DURATION);
    </script>
</body>
</html>
